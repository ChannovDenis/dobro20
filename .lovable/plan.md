

# План реализации: Добросервис — B2B2C First

## Обновлённая логика приоритетов

**Принцип:** сначала то, что продаёт партнёру → потом то, что удерживает его клиентов → потом growth.

```text
┌─────────────────────────────────────────────────────────────┐
│  ФАЗА 0: White-Label + БД (5-7 дней)                       │
│  "Вот ваше приложение с вашим логотипом"                   │
│  → Результат: демо для продажи партнёру                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  ФАЗА 1: Конверсия лента→чат→эксперт (5-7 дней)           │
│  "Ваши клиенты получают AI + живых экспертов"              │
│  → Результат: полный путь до записи к эксперту             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  ФАЗА 2: Партнёрская панель (4-5 дней)                     │
│  "Вот отчёт: 320 пользователей, 45 записей к юристу"       │
│  → Результат: партнёр продлевает контракт                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  ФАЗА 3-5: Контент, Мини-аппы, Growth                      │
│  Retention + Upsell + Виральность                          │
└─────────────────────────────────────────────────────────────┘
```

---

## ФАЗА 0: Фундамент + White-Label (5-7 дней)

**Приоритет: КРИТИЧЕСКИЙ — без этого нечего показывать партнёру**

### 0A. База данных (2 дня)

**Новые таблицы:**

| Таблица | Назначение |
|---------|------------|
| `tenants` | Партнёры (ГПБ, WB, МЭС) — slug, тема, enabled_services, квоты |
| `users` | Пользователи с привязкой к tenant_id, роли, подписка |
| `topics` | Топики/треды чата с tenant_id |
| `topic_messages` | Сообщения с ролями (user, assistant, system, expert) |
| `analytics_events` | Трекинг всех событий для отчётов партнёру |

**Задачи:**

| ID | Задача | Описание |
|----|--------|----------|
| 0A.1 | Миграция БД | Создать все таблицы + RLS-политики по `tenant_id` |
| 0A.2 | React Hooks | `useTenant()`, `useUser()`, `useTopics()`, `useAnalytics()` |
| 0A.3 | Миграция localStorage | Перенести текущие topics/messages в Supabase |
| 0A.4 | Event tracking | Логировать `feed_view`, `chat_start`, `service_click`, `expert_request` |

### 0B. White-Label Engine (3 дня)

| ID | Задача | Описание |
|----|--------|----------|
| 0B.1 | Tenant Resolver | Определение tenant по subdomain (`gpb.dobroservis.ru` → config) |
| 0B.2 | TenantContext | React Context, загружает конфиг из `tenants` таблицы |
| 0B.3 | Dynamic CSS | CSS variables из `tenant.theme` → автоперекраска UI |
| 0B.4 | Service Filter | Фильтрация сервисов по `enabled_services` |
| 0B.5 | Branding | Логотип, название AI, welcome-текст из конфига |
| 0B.6 | Seed Data | 3 тенанта: Добросервис, ГПБ, WB с разными темами |

**Файлы для изменения:**

| Файл | Изменения |
|------|-----------|
| `src/contexts/TenantContext.tsx` | Новый — загрузка tenant config |
| `src/hooks/useTenant.ts` | Новый — доступ к tenant данным |
| `src/hooks/useTopics.ts` | Новый — CRUD для топиков |
| `src/hooks/useAnalytics.ts` | Новый — трекинг событий |
| `src/index.css` | Динамические CSS variables |
| `src/App.tsx` | Обёртка в TenantProvider |
| `src/pages/Services.tsx` | Фильтрация по enabled_services |
| `src/data/mockData.ts` | Адаптация под tenant-aware структуру |

**Результат Фазы 0:** `gpb.dobroservis.ru` показывает приложение с логотипом ГПБ, их цветами и нужным набором сервисов.

---

## ФАЗА 1: Конверсия «лента → чат → эксперт» (5-7 дней)

**Приоритет: ВЫСОКИЙ — это путь к деньгам**

### 1A. Кнопка «Спросить AI» + Топики (3 дня)

| ID | Задача | Описание |
|----|--------|----------|
| 1.1 | CTA на FeedCard | Кнопка «Спросить AI» → создаёт топик с контекстом карточки |
| 1.2 | Боковая панель топиков | Sheet с историей, автоименование, переключение |
| 1.3 | Кнопка «Новый чат» | В хедере чата |

### 1B. MVP Эскалации (4 дня)

**Новая таблица:**

```text
expert_sessions
├── id (uuid, PK)
├── topic_id (uuid, FK → topics)
├── tenant_id (uuid, FK → tenants)
├── user_id (uuid, FK → users)
├── service_type (text)
├── status (enum: requested, confirmed, completed, cancelled)
├── scheduled_at (timestamp)
├── duration_minutes (int)
├── price (decimal)
└── created_at (timestamp)
```

| ID | Задача | Описание |
|----|--------|----------|
| 1.4 | Кнопка эскалации | «Записаться к эксперту» внутри чата |
| 1.5 | Форма бронирования | Выбор даты/времени, тип консультации |
| 1.6 | Статус топика | `active` → `escalated` при запросе эксперта |
| 1.7 | Event tracking воронки | `feed_cta_click → chat_start → expert_requested → expert_booked` |

**Триггеры эскалации (v1 — простые правила):**
- Пользователь написал «хочу юриста / врача / эксперта»
- AI не смог ответить 2 раза подряд
- Вопрос содержит маркеры высокого риска (здоровье, суд, деньги > 100к)
- Прямая кнопка «Связаться с экспертом» всегда доступна

**Файлы для изменения:**

| Файл | Изменения |
|------|-----------|
| `src/components/feed/FeedCard.tsx` | Добавить кнопку «Спросить AI» |
| `src/components/chat/TopicsSidebar.tsx` | Новый — боковая панель с историей |
| `src/components/chat/BookingForm.tsx` | Новый — форма записи к эксперту |
| `src/components/chat/ExpertCard.tsx` | Новый — карточка эксперта в чате |
| `src/pages/Chat.tsx` | Интеграция топиков + эскалации |
| `src/hooks/useExpertSessions.ts` | Новый — CRUD для бронирований |

**Результат Фазы 1:** полный путь от контента до записи к эксперту работает. Можно измерить конверсию.

---

## ФАЗА 2: Партнёрская панель (4-5 дней)

**Приоритет: ВЫСОКИЙ — без этого партнёр не продлит контракт**

**Новая таблица:**

```text
admin_reports
├── id (uuid, PK)
├── tenant_id (uuid, FK → tenants)
├── period_start (date)
├── period_end (date)
├── metrics (jsonb) — { dau, wau, mau, chats, escalations, bookings }
├── generated_at (timestamp)
└── file_url (text, nullable) — ссылка на PDF
```

| ID | Задача | Описание |
|----|--------|----------|
| 2.1 | Страница `/admin` | Доступ по role: `partner_admin` |
| 2.2 | Дашборд | DAU/WAU/MAU, топ сервисов, кол-во обращений |
| 2.3 | Воронка | Просмотры ленты → чаты → эскалации → бронирования |
| 2.4 | Экспорт PDF | Отчёт для руководства партнёра |
| 2.5 | Управление пользователями | Список, статусы, блокировка |
| 2.6 | Настройки тенанта | Включение/выключение сервисов, смена логотипа |

**Новые файлы:**

| Файл | Описание |
|------|----------|
| `src/pages/Admin.tsx` | Главная страница админки |
| `src/components/admin/Dashboard.tsx` | Графики и метрики |
| `src/components/admin/FunnelChart.tsx` | Визуализация воронки |
| `src/components/admin/UsersTable.tsx` | Таблица пользователей |
| `src/components/admin/TenantSettings.tsx` | Настройки партнёра |
| `src/hooks/useAdminMetrics.ts` | Агрегация данных из analytics_events |

**Результат Фазы 2:** партнёр-админ ГПБ видит «320 сотрудников воспользовались, 45 записались к юристу» — и продлевает контракт.

---

## ФАЗА 3: Контент-машина (3-4 дня)

**Приоритет: СРЕДНИЙ — retention для пользователей партнёра**

**Новая таблица:**

```text
feed_items
├── id (uuid, PK)
├── tenant_id (uuid, nullable — null = для всех)
├── title (text)
├── description (text)
├── media_url (text)
├── media_type (enum: video, image, article)
├── category (text)
├── tags (text[])
├── cta_type (enum: chat, service, external_link, none)
├── cta_payload (jsonb)
├── published_at (timestamp)
├── is_promo (boolean)
└── clicks (int, default 0)
```

| ID | Задача | Описание |
|----|--------|----------|
| 3.1 | Таблица feed_items | Контент с tenant_id (общий или кастомный) |
| 3.2 | CMS-лайт | Загрузка контента через admin-панель |
| 3.3 | Фильтрация по тегам | По enabled_services тенанта |
| 3.4 | VideoGen интеграция | Автозаливка роликов в ленту |
| 3.5 | PromoCard с CPA | Партнёрские карточки с трекингом кликов |

---

## ФАЗА 4: Мини-приложения (5-7 дней)

**Приоритет: СРЕДНИЙ — дифференциация и upsell**

| ID | Задача | Описание |
|----|--------|----------|
| 4.1 | MiniApp Registry | Реестр с tenant-фильтрацией |
| 4.2 | Анализатор чеков | OCR → рекомендации (полезен для ГПБ) |
| 4.3 | Проверка смет AI | Для МЭС |
| 4.4 | AI-стилист | Уже есть edge functions (полезен для WB) |
| 4.5 | Analytics integration | Каждый мини-апп логирует события |

**Upsell модель:** «Хотите добавить AI-стилиста? +X руб/мес за пользователя»

---

## ФАЗА 5: Growth (3-4 дня)

**Приоритет: НИЗКИЙ — только после стабильного retention**

| ID | Задача | Описание |
|----|--------|----------|
| 5.1 | Referral внутри тенанта | Сотрудник приглашает коллегу |
| 5.2 | Push-уведомления | Новый контент, напоминания |
| 5.3 | D2C landing | `dobroservis.ru` для органического трафика |
| 5.4 | Витрина мини-аппов | Upsell: «есть, но не включено в ваш тариф» |

---

## Backlog (после D30 > 10%)

- Геймификация (баллы, достижения, стрики)
- Полный marketplace товаров
- Room planner (AI-обмер помещения)
- Sentiment-based автоэскалация
- Мультиязычность (BRICS-экспансия)

---

## Сводная таблица

| Фаза | Название | Дни | Что продаёт партнёру |
|------|----------|-----|---------------------|
| 0 | Фундамент + White-Label | 5-7 | «Вот ваше приложение с вашим логотипом» |
| 1 | Конверсия → эксперт | 5-7 | «Ваши клиенты получают AI + живых экспертов» |
| 2 | Партнёрская панель | 4-5 | «Вот отчёт: 320 пользователей, 45 записей» |
| 3 | Контент-машина | 3-4 | «2-3 ролика в день, клиенты возвращаются» |
| 4 | Мини-приложения | 5-7 | «Добавьте AI-стилиста за +X/мес» |
| 5 | Growth | 3-4 | «Виральное распространение внутри компании» |

**Общий таймлайн: 6-8 недель**
**До первого демо партнёру (Фаза 0): 5-7 дней**

---

## Рекомендуемый первый шаг

Начать с **Фазы 0A** — создание базы данных:
1. Миграция: таблицы `tenants`, `users`, `topics`, `topic_messages`, `analytics_events`
2. RLS-политики по `tenant_id`
3. Seed data для 3 тенантов (Добросервис, ГПБ, WB)

Это фундамент для всего остального.

