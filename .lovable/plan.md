

# План: Редизайн системы тем чата и эскалации к эксперту

## Текущая ситуация

Сейчас при нажатии на "+" в чате открывается `TemplatesModal`, который просто вставляет текстовый промпт в поле ввода. Проблемы:
1. Все сообщения идут в один общий тред — обсуждения смешиваются
2. Нет чёткого пути эскалации к живому эксперту
3. История чатов не структурирована по темам/сервисам

## Предлагаемое решение

### 1. Новый тред при выборе сервиса

Когда пользователь выбирает шаблон/сервис через "+", создаётся **новый топик** в базе данных со следующими данными:
- `service_type` — тип сервиса (lawyer, doctor и т.д.)
- `title` — автоматически генерируется из первого сообщения
- `context` — контекстные данные (service-specific)

```text
┌──────────────────────────────────────┐
│  Выбрать тему                        │
├──────────────────────────────────────┤
│  📷 Загрузить фото                   │
│  ─────────────────────────────────── │
│  ⚖️ Юридический вопрос               │
│      → Создаёт новый тред            │
│  ❤️ Вопрос про здоровье              │
│      → Создаёт новый тред            │
│  🧮 Проверить смету                  │
│      → Создаёт новый тред            │
│  ...                                 │
├──────────────────────────────────────┤
│  📂 Продолжить чат...                │
│      → Список активных топиков       │
└──────────────────────────────────────┘
```

### 2. Индикатор эскалации в заголовке чата

В хедере чата добавляем кнопку "К эксперту" с индикатором доступности:

```text
┌────────────────────────────────────────────┐
│  ✕  │  ⚖️ Юрист Алексей  │  👤 Эксперт ↗  │
└────────────────────────────────────────────┘
```

Кнопка показывает:
- Количество доступных экспертов
- "Скоро" если эксперты недоступны
- Переход на страницу `/service/{serviceId}` для записи

### 3. Умные подсказки эскалации в чате

AI будет добавлять кнопку эскалации в определённых сценариях:
- После 5+ сообщений на одну тему
- При обнаружении сложного запроса (юридические документы, диагноз и т.д.)
- При явном запросе пользователя

```text
┌──────────────────────────────────────────┐
│ 🤖 Ассистент:                            │
│ Для составления искового заявления       │
│ рекомендую консультацию с юристом.       │
│                                          │
│ ┌────────────────────────────────────┐   │
│ │  👤 Записаться к юристу            │   │
│ │  от 1500₽ · Доступен сегодня       │   │
│ └────────────────────────────────────┘   │
└──────────────────────────────────────────┘
```

### 4. Панель контекста топика

Под заголовком показываем контекстную информацию:

```text
┌──────────────────────────────────────────┐
│ Тема: Развод и раздел имущества          │
│ Сообщений: 8 · Начат: сегодня            │
│ ──────────────────────────────────────── │
│ [Сообщения чата...]                      │
└──────────────────────────────────────────┘
```

---

## Технические изменения

### Шаг 1: Обновление `TemplatesModal.tsx`

Переименовать в `NewTopicModal.tsx` с функциональностью:
- Создание нового топика при выборе шаблона
- Секция "Продолжить существующий чат"
- Интеграция с хуком `useTopics`

### Шаг 2: Обновление `useChat.ts`

Интегрировать с `useTopics`:
- Сохранять сообщения в `topic_messages`
- Загружать историю при переключении топиков
- Автоматическая генерация заголовка темы

### Шаг 3: Обновление `Chat.tsx`

- Добавить кнопку эскалации в хедер
- Показывать контекстную панель топика
- Управление переключением между топиками

### Шаг 4: Создание `EscalationCard.tsx`

Новый компонент для inline-эскалации:
- Показывает доступных экспертов
- Цены и ближайшие слоты
- Переход к записи

### Шаг 5: Обновление `ChatMessage.tsx`

Поддержка нового типа кнопки:
- `escalate` — переход к записи эксперта
- Отображение карточки эскалации

### Шаг 6: Обновление типов

Расширить `ActionButton`:
```typescript
export type ChatAction =
  | ... existing
  | "escalate"
  | "new_topic";
```

---

## UX лучших практик (на основе исследования)

1. **Видимый путь к эксперту** — кнопка "К эксперту" всегда доступна в хедере
2. **Контекстная эскалация** — AI предлагает эксперта в нужный момент
3. **Передача контекста** — история чата передаётся эксперту при записи
4. **Прозрачность** — показываем цены и доступность заранее
5. **Разделение тем** — каждый запрос = новый структурированный топик

---

## Файлы для изменения

| Файл | Изменения |
|------|-----------|
| `src/components/chat/TemplatesModal.tsx` | → `NewTopicModal.tsx`, интеграция с `useTopics` |
| `src/components/chat/ChatInput.tsx` | Использование нового модала |
| `src/hooks/useChat.ts` | Интеграция с топиками БД |
| `src/pages/Chat.tsx` | Хедер с эскалацией, панель топика |
| `src/components/chat/EscalationCard.tsx` | Новый компонент |
| `src/components/chat/ChatMessage.tsx` | Поддержка `escalate` action |
| `src/types/chat.ts` | Новые типы и actions |
| `src/constants/chatActions.ts` | Логика эскалации |

